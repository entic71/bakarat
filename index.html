<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>강남랜드 — 단계형 코인 게임</title>
<style>
:root{
  --bg:#061427;
  --panel:#0b1f3a;
  --accent:#0ea5ff;
  --accent2:#00b4ff;
  --muted:#9fb6d9;
}

html,body{
  height:100%;
  margin:0;
  font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;
  background:radial-gradient(circle at top,#061427,#04233b 80%);
  color:#e6f0ff;
}

.container{
  max-width:1100px;
  margin:28px auto;
  padding:20px;
  display:grid;
  grid-template-columns:320px 1fr;
  gap:20px;
}

.panel{
  background:linear-gradient(145deg,#0b1f3a,#0d2945);
  border-radius:16px;
  padding:22px;
  border:1px solid rgba(14,165,255,0.2);
  box-shadow:0 8px 28px rgba(14,165,255,0.25),0 0 40px rgba(0,180,255,0.15) inset;
  transition:0.3s;
}
.panel:hover{
  box-shadow:0 12px 36px rgba(14,165,255,0.35),0 0 60px rgba(0,180,255,0.25) inset;
}

.brand .logo{
  font-weight:900;
  font-size:24px;
  color:var(--accent);
  text-shadow:0 0 8px var(--accent),0 0 20px var(--accent2);
}

label{
  display:block;
  margin-top:10px;
  color:var(--muted);
  font-size:13px;
}

input[type=text],input[type=password],input[type=number]{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.1);
  background:rgba(0,0,0,0.15);
  color:#fff;
  margin-top:6px;
  box-shadow:0 0 10px rgba(14,165,255,0.2) inset;
  transition:0.2s;
}
input[type=text]:focus,input[type=password]:focus,input[type=number]:focus{
  border-color:var(--accent2);
  box-shadow:0 0 15px var(--accent2);
  outline:none;
}

.btn{
  display:inline-block;
  padding:12px 16px;
  border-radius:12px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#002236;
  font-weight:700;
  border:none;
  cursor:pointer;
  text-shadow:0 0 6px #fff;
  transition:0.2s;
}
.btn:hover{
  transform:scale(1.05);
  box-shadow:0 0 18px var(--accent),0 0 35px var(--accent2);
}
.btn.alt{
  background:transparent;
  border:1px solid rgba(255,255,255,0.15);
  color:var(--accent);
}

.game{
  background:linear-gradient(145deg,#0b1f3a,#0d2945);
  border-radius:16px;
  padding:22px;
  border:1px solid rgba(14,165,255,0.1);
  box-shadow:0 8px 28px rgba(14,165,255,0.2),0 0 40px rgba(0,180,255,0.1) inset;
  transition:0.3s;
}
.game:hover{
  box-shadow:0 12px 36px rgba(14,165,255,0.3),0 0 60px rgba(0,180,255,0.2) inset;
}

.toprow{
  display:flex;
  align-items:center;
  gap:12px;
}
.credits{
  font-size:18px;
  font-weight:800;
  color:var(--accent);
  text-shadow:0 0 6px var(--accent);
}
.stage{
  margin-left:auto;
  color:var(--muted);
}

.coin-wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  margin:20px 0;
  position:relative;
}

.coin{
  width:150px;
  height:150px;
  border-radius:50%;
  position:relative;
  transform-style:preserve-3d;
  cursor:pointer;
  box-shadow:0 0 25px var(--accent),0 0 50px var(--accent2) inset;
  transition:transform 1s ease-in-out;
}
.coin-face{
  position:absolute;
  inset:0;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:22px;
  backface-visibility:hidden;
  border:6px solid rgba(255,255,255,0.1);
  text-shadow:0 0 4px #fff;
}
.coin-front{
  background:radial-gradient(circle at 30% 25%, #bff1ff, #60c0ff);
  box-shadow:0 0 20px #0ea5ff inset;
}
.coin-back{
  background:radial-gradient(circle at 70% 75%, #8fd1ff, #0ea5ff);
  transform:rotateY(180deg);
  box-shadow:0 0 20px #00b4ff inset;
}

.coin.spin{
  animation:spin 1.2s cubic-bezier(.2,.8,.2,1);
}

@keyframes spin{
  from{transform:rotateY(0)}
  to{transform:rotateY(1440deg)}
}

.glow{
  width:260px;
  height:260px;
  border-radius:50%;
  filter:blur(45px);
  opacity:0.85;
  position:absolute;
  z-index:-1;
  transition:0.3s;
}
.glow.win{background:radial-gradient(circle,#8ef3ff, transparent 50%);}
.glow.lose{background:radial-gradient(circle,#ff6b6b, transparent 50%);}

.controls{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.controls .wide{
  flex:1;
}

#log{
  margin-top:12px;
  padding:14px;
  background:rgba(0,0,0,0.2);
  border-radius:12px;
  min-height:120px;
  overflow:auto;
  box-shadow:0 0 15px rgba(14,165,255,0.15) inset;
}
.log-item{
  font-size:13px;
  color:var(--muted);
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  padding:6px;
  text-align:left;
  font-size:13px;
}
thead th{
  color:var(--muted);
  font-weight:600;
}

/* 팝업 */
.modal-back{
  position:fixed;
  inset:0;
  background:rgba(2,6,23,0.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}
.modal{
  background:linear-gradient(145deg,#0b1f3a,#0d2945);
  border-radius:16px;
  padding:22px;
  border:1px solid rgba(14,165,255,0.1);
  box-shadow:0 0 28px var(--accent),0 0 50px var(--accent2) inset;
  min-width:320px;
  transition:0.3s;
}
</style>
</head>
<body>
<div class="container">
  <div class="panel">
    <div class="brand"><div class="logo">강남랜드</div></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btnLogin" class="btn">로그인</button>
      <button id="btnSignup" class="btn alt">회원가입</button>
    </div>
    <div class="muted" style="margin-top:10px">기본 100크레딧으로 시작</div>
    <hr style="margin:14px 0;border:none;height:1px;background:rgba(255,255,255,0.03)">
    <h3>랭킹</h3>
    <table id="rankPreview"><thead><tr><th>순위</th><th>학번</th><th>크레딧</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="game">
    <div class="toprow"><div class="credits">크레딧: <span id="credits">0</span></div><div class="stage">단계: <strong id="stageLabel">-</strong></div></div>
    <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
      <label>배팅 금액</label>
      <input id="bet" type="number" value="10" min="1">
    </div>
    <div style="position:relative;display:flex;flex-direction:column;align-items:center">
      <div id="glow" class="glow" style="display:none"></div>
      <div class="coin-wrap">
        <div id="coin" class="coin heads">
          <div class="coin-face coin-front">앞면</div>
          <div class="coin-face coin-back">뒷면</div>
        </div>
      </div>
    </div>
    <div class="controls">
      <button id="startBtn" class="btn wide">게임 시작</button>
      <button id="goBtn" class="btn wide" disabled>GO</button>
      <button id="stopBtn" class="btn wide" disabled>STOP</button>
    </div>
    <div id="log"></div>
  </div>
</div>

<div class="modal-back" id="authModal">
  <div class="modal">
    <h3 id="authTitle">로그인</h3>
    <label>학번</label>
    <input id="authId" type="text" placeholder="학번 입력">
    <label>비밀번호</label>
    <input id="authPwd" type="password" placeholder="비밀번호 입력">
    <button id="authBtn" class="btn wide">확인</button>
    <button id="switchAuth" class="btn alt wide" style="margin-top:6px">회원가입 전환</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, set, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAaYIB1Ows4tOVIQotQCyFHFR2h3pBEeTg",
  authDomain: "jungportfolio-b803e.firebaseapp.com",
  databaseURL: "https://jungportfolio-b803e-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jungportfolio-b803e",
  storageBucket: "jungportfolio-b803e.appspot.com",
  messagingSenderId: "204994545121",
  appId: "1:204994545121:web:d3e6879b5061781b433ea0"
};

const app = initializeApp(FIREBASE_CONFIG);
const db = getDatabase(app);
const usersRef = ref(db,'users');

const stages=[
  {name:'1단계',prob:0.8,mult:1.1},{name:'2단계',prob:0.7,mult:1.3},
  {name:'3단계',prob:0.6,mult:1.5},{name:'4단계',prob:0.5,mult:1.8},
  {name:'5단계',prob:0.3,mult:2.5},{name:'6단계',prob:0.2,mult:4},
  {name:'7단계',prob:0.1,mult:8}
];

// DOM
const rankPreviewTbody=document.querySelector('#rankPreview tbody'),
creditsEl=document.getElementById('credits'),
stageLabel=document.getElementById('stageLabel'),
betEl=document.getElementById('bet'),
startBtn=document.getElementById('startBtn'),
goBtn=document.getElementById('goBtn'),
stopBtn=document.getElementById('stopBtn'),
coinEl=document.getElementById('coin'),
glowEl=document.getElementById('glow'),
logEl=document.getElementById('log'),
btnLogin=document.getElementById('btnLogin'),
btnSignup=document.getElementById('btnSignup'),
authModal=document.getElementById('authModal'),
authTitle=document.getElementById('authTitle'),
authId=document.getElementById('authId'),
authPwd=document.getElementById('authPwd'),
authBtn=document.getElementById('authBtn'),
switchAuth=document.getElementById('switchAuth');

let loginMode=true, currentUser=null, userCredits=0, currentStageIndex=-1, currentBet=0, started=false;

function appendLog(t){let d=document.createElement('div');d.className='log-item';d.textContent=`${new Date().toLocaleTimeString()} — ${t}`;logEl.prepend(d);}

function openAuthModal(mode='login'){loginMode=mode==='login';authTitle.textContent=loginMode?'로그인':'회원가입';authBtn.textContent='확인';authId.value='';authPwd.value='';authModal.style.display='flex';}
function closeAuthModal(){authModal.style.display='none';}
authModal.addEventListener('click', e=>{if(e.target===authModal) closeAuthModal();});
switchAuth.addEventListener('click', ()=>openAuthModal(loginMode?'signup':'login'));
btnLogin.addEventListener('click', ()=>openAuthModal('login'));
btnSignup.addEventListener('click', ()=>openAuthModal('signup'));

authBtn.addEventListener('click', async()=>{
  const id=authId.value.trim(), pwd=authPwd.value.trim();
  if(!id||!pwd){alert('학번과 비밀번호 필요');return;}
  const userRef = ref(db, `users/${id}`);
  const snapshot = await get(userRef);
  if(loginMode){
    if(!snapshot.exists()){alert('회원 없음');return;}
    const data=snapshot.val();
    if(data.password!==pwd){alert('비밀번호 불일치');return;}
    currentUser=id; userCredits=data.credits||0; creditsEl.textContent=userCredits;
    appendLog(`${id} 로그인 성공`);
  } else {
    if(snapshot.exists()){alert('이미 존재하는 학번');return;}
    await set(userRef,{password:pwd,credits:100});
    alert('가입 완료! 로그인 해주세요.');
    closeAuthModal();
    return;
  }
  closeAuthModal();
  loadRankPreview();
});

startBtn.addEventListener('click',()=>{
  if(!currentUser){alert('먼저 로그인'); return;}
  let bet=Number(betEl.value)||0; if(bet<=0||bet>userCredits){alert('배팅액 확인'); return;}
  currentBet=bet; currentStageIndex=0; started=true;
  startBtn.disabled=true; goBtn.disabled=true; stopBtn.disabled=true;
  stageLabel.textContent=stages[currentStageIndex].name;
  appendLog(`배팅 ${bet} 시작`);
  attemptStage();
});

async function attemptStage(){
  let prob=stages[currentStageIndex].prob;
  appendLog(`${stages[currentStageIndex].name} 시도 (성공확률 ${Math.round(prob*100)}%)`);
  let ok=Math.random()<prob;
  coinEl.classList.remove('heads','tails'); coinEl.classList.add('spin');
  glowEl.style.display='block'; glowEl.className='glow';
  setTimeout(async()=>{
    coinEl.classList.remove('spin'); coinEl.classList.add(ok?'heads':'tails');
    glowEl.className=ok?'glow win':'glow lose';
    if(ok){goBtn.disabled=false; stopBtn.disabled=false; appendLog('성공!');}
    else{ appendLog('실패!'); userCredits-=currentBet; if(userCredits<0)userCredits=0; creditsEl.textContent=userCredits; await set(ref(db,`users/${currentUser}/credits`),userCredits); resetRun();}
  },1200);
}

goBtn.addEventListener('click',()=>{
  if(!started||currentStageIndex>=stages.length-1)return;
  currentStageIndex++; stageLabel.textContent=stages[currentStageIndex].name;
  goBtn.disabled=true; stopBtn.disabled=true; appendLog(`다음 단계: ${stages[currentStageIndex].name}`);
  attemptStage();
});

stopBtn.addEventListener('click', async()=>{
  if(!started)return;
  let payout=Math.floor(currentBet*stages[currentStageIndex].mult);
  appendLog(`STOP 회수: ${payout}`);
  userCredits+=payout; creditsEl.textContent=userCredits;
  await set(ref(db,`users/${currentUser}/credits`),userCredits);
  resetRun();
});

function resetRun(){currentStageIndex=-1;started=false;currentBet=0;startBtn.disabled=false;goBtn.disabled=true;stopBtn.disabled=true;stageLabel.textContent='-';glowEl.style.display='none';}

async function loadRankPreview(){
  onValue(usersRef, snapshot=>{
    const data=snapshot.val()||{};
    const arr=Object.entries(data).map(([id,val])=>({id,credits:val.credits||0})).sort((a,b)=>b.credits-a.credits).slice(0,5);
    rankPreviewTbody.innerHTML='';
    arr.forEach((u,i)=>{let tr=document.createElement('tr');tr.innerHTML=`<td>${i+1}</td><td>${u.id}</td><td>${u.credits}</td>`;rankPreviewTbody.appendChild(tr);});
  });
}

loadRankPreview();
</script>
</body>
</html>
